<!DOCTYPE html>
<html>
<head>
  <title>Debug Line2 Rendering</title>
  <style>
    body { margin: 0; background: #111; color: #fff; font-family: monospace; padding: 20px; }
    canvas { border: 2px solid #333; display: block; margin: 10px 0; }
    #log { white-space: pre-wrap; font-size: 12px; max-height: 400px; overflow: auto; background: #222; padding: 10px; }
  </style>
</head>
<body>
  <h3>Test 1: Raw Three.js Line2 (no manimweb)</h3>
  <div id="container1"></div>
  <h3>Test 2: Manimweb Circle (no animation)</h3>
  <div id="container2"></div>
  <h3>Test 3: Manimweb Circle + Create animation</h3>
  <div id="container3"></div>
  <h3>Debug Log</h3>
  <div id="log"></div>

  <script type="module">
    import * as THREE from 'three';
    import { Line2 } from 'three/examples/jsm/lines/Line2.js';
    import { LineMaterial } from 'three/examples/jsm/lines/LineMaterial.js';
    import { LineGeometry } from 'three/examples/jsm/lines/LineGeometry.js';

    const log = (msg) => {
      document.getElementById('log').textContent += msg + '\n';
      console.log(msg);
    };

    log('Three.js version: ' + THREE.REVISION);

    // ========== TEST 1: Raw Three.js Line2 ==========
    try {
      const W = 800, H = 450;
      const renderer1 = new THREE.WebGLRenderer({ antialias: true });
      renderer1.setSize(W, H);
      renderer1.setPixelRatio(Math.min(window.devicePixelRatio, 2));
      renderer1.setClearColor(0x1a1a2e);
      document.getElementById('container1').appendChild(renderer1.domElement);

      const scene1 = new THREE.Scene();
      const camera1 = new THREE.OrthographicCamera(-7, 7, 4, -4, 0.1, 1000);
      camera1.position.set(0, 0, 10);
      camera1.lookAt(0, 0, 0);

      // Create a circle path manually (same as manimweb Circle)
      const kappa = (4 / 3) * (Math.SQRT2 - 1);
      const r = 1.5;
      const samples = [];
      // Sample 4 bezier segments
      const bezierSegments = [
        [[r, 0, 0], [r, r*kappa, 0], [r*kappa, r, 0], [0, r, 0]],
        [[0, r, 0], [-r*kappa, r, 0], [-r, r*kappa, 0], [-r, 0, 0]],
        [[-r, 0, 0], [-r, -r*kappa, 0], [-r*kappa, -r, 0], [0, -r, 0]],
        [[0, -r, 0], [r*kappa, -r, 0], [r, -r*kappa, 0], [r, 0, 0]],
      ];
      for (const seg of bezierSegments) {
        for (let t = 0; t <= 1; t += 0.25) {
          const mt = 1 - t;
          const x = mt*mt*mt*seg[0][0] + 3*mt*mt*t*seg[1][0] + 3*mt*t*t*seg[2][0] + t*t*t*seg[3][0];
          const y = mt*mt*mt*seg[0][1] + 3*mt*mt*t*seg[1][1] + 3*mt*t*t*seg[2][1] + t*t*t*seg[3][1];
          const z = 0;
          if (samples.length === 0 || Math.abs(x - samples[samples.length-3]) > 0.001 || Math.abs(y - samples[samples.length-2]) > 0.001) {
            samples.push(x, y, z);
          }
        }
      }

      log(`Test 1: ${samples.length / 3} sampled points`);

      const geom1 = new LineGeometry();
      geom1.setPositions(samples);

      // IMPORTANT: resolution must match the renderer size
      const mat1 = new LineMaterial({
        color: 0xe94560,
        linewidth: 4, // pixels
        resolution: new THREE.Vector2(W, H), // Must match renderer!
      });

      const line1 = new Line2(geom1, mat1);
      line1.computeLineDistances();
      scene1.add(line1);

      renderer1.render(scene1, camera1);
      log('Test 1: Rendered âœ“');

      // Also test with window size resolution (the bug)
      const mat1b = new LineMaterial({
        color: 0x00ff00,
        linewidth: 2,
        resolution: new THREE.Vector2(window.innerWidth, window.innerHeight), // wrong!
      });
      log(`Test 1: Window size = ${window.innerWidth}x${window.innerHeight}, Canvas = ${W}x${H}`);
      log(`Test 1: DPR = ${window.devicePixelRatio}`);

    } catch(e) {
      log('Test 1 ERROR: ' + e.message);
      console.error(e);
    }

    // ========== TEST 2: Manimweb Circle without animation ==========
    try {
      const { Scene, Circle } = await import('../src/index.ts');

      const container2 = document.getElementById('container2');
      const scene2 = new Scene(container2, {
        width: 800,
        height: 450,
        backgroundColor: '#1a1a2e'
      });

      const c2 = new Circle({ radius: 1.5, color: '#e94560', strokeWidth: 4 });
      scene2.add(c2);

      // Debug the Three.js object
      const threeObj = c2.getThreeObject();
      log(`Test 2: Three object type = ${threeObj.constructor.name}`);
      log(`Test 2: Children count = ${threeObj.children.length}`);
      threeObj.traverse((child) => {
        log(`  Child: ${child.constructor.name}`);
        if (child instanceof Line2) {
          const m = child.material;
          log(`    linewidth=${m.linewidth}, color=${m.color.getHexString()}, opacity=${m.opacity}`);
          log(`    resolution=${m.resolution.x}x${m.resolution.y}`);
          log(`    dashed=${m.dashed}`);
          const g = child.geometry;
          log(`    geometry attributes: ${Object.keys(g.attributes).join(', ')}`);
          if (g.attributes.instanceStart) {
            log(`    instanceStart count=${g.attributes.instanceStart.count || g.attributes.instanceStart.data?.count}`);
          }
          // Check bounding sphere
          g.computeBoundingSphere();
          if (g.boundingSphere) {
            log(`    boundingSphere: center=(${g.boundingSphere.center.x.toFixed(2)},${g.boundingSphere.center.y.toFixed(2)},${g.boundingSphere.center.z.toFixed(2)}) radius=${g.boundingSphere.radius.toFixed(2)}`);
          }
        }
      });
      log('Test 2: Circle added (no animation)');

    } catch(e) {
      log('Test 2 ERROR: ' + e.message);
      console.error(e);
    }

    // ========== TEST 3: Manimweb Circle + Create ==========
    try {
      const { Scene, Circle, Create } = await import('../src/index.ts');

      const container3 = document.getElementById('container3');
      const scene3 = new Scene(container3, {
        width: 800,
        height: 450,
        backgroundColor: '#1a1a2e'
      });

      const c3 = new Circle({ radius: 1.5, color: '#00ff88', strokeWidth: 4 });
      scene3.add(c3);
      log('Test 3: Circle added, about to play Create...');

      await scene3.play(new Create(c3));
      log('Test 3: Create animation complete');

    } catch(e) {
      log('Test 3 ERROR: ' + e.message);
      console.error(e);
    }
  </script>
</body>
</html>
